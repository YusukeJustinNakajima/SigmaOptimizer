
# <img src="https://github.com/user-attachments/assets/882178cc-6873-49dd-a725-2c201753b0f7" alt="SigmaOptimizer Logo" width="3.5%"> SigmaOptimizer <br> ~ Automated Sigma Rule Generation and Optimization ~  

## 🎯 Overview  
**SigmaOptimizer** is a **Sigma rule generation and optimization tool** that automatically creates, tests, and improves Sigma rules based on real-world logs using **LLM**.  
It is implemented as a PowerShell script and **integrates log analysis, rule evaluation, and iterative refinement** to enhance detection capabilities.  

✅ **Automated Sigma rule generation**  
✅ **Rule validation with syntax checks (Invoke-SigmaRuleTests)**  
✅ **Detection rate measurement using [Hayabusa](https://github.com/Yamato-Security/hayabusa)**  
✅ **FP check of created rules using [evtx-baseline](https://github.com/NextronSystems/evtx-baseline)**  
✅ **Command obfuscation support ([Invoke-ArgFuscator](https://github.com/wietze/Invoke-ArgFuscator)) for robust detection**  

https://github.com/user-attachments/assets/4747e9e3-3805-47fa-b0ad-f5cde5d06161

---

## 📜 Background
🔹 LLM-based Sigma rule creation has inherent limitations. **When generating rules solely based on user prompts, without analyzing real-world logs, it is impossible to determine which log events are actually generated by the behavior you want to detect. This makes prompt-based rule creation unreliable for robust detection.**.  
🔹 **LLM-based rule generation often relies solely on user prompts**, leading to **hallucinations** because the model lacks access to real event logs. This results in **shallow and easily bypassed** detection rules.  
🔹 **Rule creation and validation are often separate processes**, meaning even improved rules need to be re-validated manually, which is inefficient.  
🔹 **Creating effective Sigma rules requires a deep understanding of threats.** While it's possible to create rules with limited knowledge, such rules are **easily bypassed by attackers** due to their simplicity.  

---

## ✨ Features  
🔹 **End-to-end rule creation, syntax validation, detection testing, and improvement** in a single workflow.  
🔹 **Log-based rule generation**, rather than relying on user prompts, ensuring rules align with actual system events.  
🔹 **Automated command obfuscation support**, allowing rules to be more resilient against evasion techniques.  
🔹 **Reducing hallucinations through multiple validation mechanisms**  

---
## 🚀 Usage  
### 🔧 Prerequisites   
- **Windows environment**  
- **PowerShell 5.1 or later**  
- **OpenAI API Key (Currently, only OpenAI is supported)**  
  - You need to set up an **environment variable** for the API key:  
    ```powershell
    $env:OPENAI_APIKEY = "your_api_key_here"
    ```
- **Required PowerShell Modules**  
  The script depends on the following PowerShell modules:  
  - `Pester` (for running tests)  
  - `powershell-yaml` (for parsing YAML files)  
  - `Invoke-ArgFuscator` (for command obfuscation) 

  Install them using:  
  ```powershell
  Install-Module Pester -Force -SkipPublisherCheck
  Install-Module powershell-yaml -Force
  Install-Module Invoke-ArgFuscator -Force
  ```
- **Extract the Archive**
  - Ensure the benign_evtx_logs/win10-client.tgz file is fully extracted before running the script.
  - The default is only to check FP using the normal logs obtained in the **win10 client environment**, so please add your logs according to your environment!(or use [evtx-baseline](https://github.com/NextronSystems/evtx-baseline))
  ```powershell
  tar -xvzf benign_evtx_logs/win10-client.tgz -C benign_evtx_logs/
  ```
  
### 🏁 Execution Steps  
1. **Launch Powershell with administrative privileges**

2. **Run the script**  
    ```powershell
    .\SigmaOptimizer.ps1
    ```

3. **Select execution environment**  
    ```
    Choose execution environment (ps for PowerShell, cmd for CMD)
    ```

4. **Enter the command to execute**  
    ```
    Enter the command to execute
    ```

5. **Select Log Source**
    ```
    Select the log sources to use:
    1. Application
    2. Security
    3. System
    4. Microsoft-Windows-Sysmon/Operational
    
    Enter the numbers corresponding to the log sources you want to use, separated by commas (Press Enter for all)::
    ```
    
6. **Review generated Sigma rules**  
    - Rules are saved in `.yml` format under `rules/generate_rules/`.  

7. **Run detection test with Hayabusa**  
    - Enter `y` to execute Hayabusa and validate the rule.  
    ```
    Execute Hayabusa with this Sigma rule? (y/n)
    ```

8. **Generate new Sigma Rule based on previous rules**
   - Enter y to generate new rules.
    ```
    Generate new Sigma Rule based on previous rules? (y/n):
    ```
9. **Check False Positive for normal logs**
    - Enter y to check false positive.
    ```
    Check how much FP is generated by the rules you create? (y/n):
    ```
---
## ✨ Tool Execution Flow 
![diagram (5)](https://github.com/user-attachments/assets/8578d5a5-0276-4fdf-ba8d-0bf571020fa8)

---
## 🤝 Contributing  
We would love to hear your feedback and contributions! 🚀  
If you try **SigmaOptimizer** and have suggestions for improvements, **please submit a pull request or create an issue** on GitHub. Your contributions will help make this tool even better!  

💡 **Ways to contribute:**  
- Report **bugs** or **feature requests** via GitHub Issues 🐛  
- Submit **pull requests** to enhance the rule generation logic 🔧  
- Improve **documentation** or add **new functionalities** 📝  

Your input is greatly appreciated! 🙌

---
## 🔮 Future Work  
🔹 **Further optimization of Sigma rule generation**  
🔹 **Testing generalization performance (e.g., ensuring that rules created based on two obfuscation patterns also work against other obfuscation patterns).**  
🔹 **Additional syntax checks (e.g., preventing minor mistakes such as using contain instead of contains and automatically correcting small errors in the detection field).**  
🔹 **A machine learning-powered feature that filters distinctive logs to optimize LLM input and avoid rate limits.**

---

SigmaOptimizer **simplifies and automates threat hunting** by enabling efficient rule generation and validation. Try it out to enhance your **Sigma-based detection strategy!** 🚀

